# Workflow pour mise Ã  jour automatique des mÃ©triques
# DÃ©clenchÃ© quotidiennement Ã  2h UTC et manuellement via workflow_dispatch

name: Update Metrics

on:
  schedule:
    # Tous les jours Ã  2h UTC (3h CET, 4h CEST)
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      force_update:
        description: "Forcer la mise Ã  jour mÃªme si aucune modification"
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: ~/.cache/pip
  PYTHONUNBUFFERED: 1

permissions:
  contents: write
  pull-requests: write

jobs:
  update-metrics:
    name: "Mise Ã  jour automatique des mÃ©triques"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: "Install Dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: "VÃ©rifier projects.json"
        run: |
          if [ ! -f "projects.json" ]; then
            echo "âŒ projects.json non trouvÃ©"
            exit 1
          fi
          echo "âœ… projects.json trouvÃ©"
          cat projects.json | head -20

      - name: "AgrÃ©ger les mÃ©triques"
        run: |
          echo "ðŸ“Š AgrÃ©gation des mÃ©triques..."
          arkalia-metrics aggregate projects.json \
            --readme-table \
            --json \
            --output metrics \
            --verbose

      - name: "GÃ©nÃ©rer les badges"
        run: |
          echo "ðŸ·ï¸ GÃ©nÃ©ration des badges..."
          if [ -f "metrics/metrics_for_badges.json" ]; then
            arkalia-metrics badges metrics/metrics_for_badges.json \
              --github-owner arkalia-luna-system \
              --github-repo arkalia-metrics-collector \
              --pypi-name arkalia-metrics-collector \
              --output metrics/badges_final.md \
              --verbose
          else
            echo "âš ï¸ metrics_for_badges.json non trouvÃ©, crÃ©ation..."
            python scripts/create_badges_metrics.py
            arkalia-metrics badges metrics/metrics_for_badges.json \
              --github-owner arkalia-luna-system \
              --github-repo arkalia-metrics-collector \
              --pypi-name arkalia-metrics-collector \
              --output metrics/badges_final.md \
              --verbose
          fi

      - name: "Mettre Ã  jour README.md"
        run: |
          echo "ðŸ“ Mise Ã  jour du README..."
          python scripts/update_readme_metrics.py

      - name: "VÃ©rifier les alertes"
        id: check-alerts
        continue-on-error: true
        run: |
          echo "ðŸš¨ VÃ©rification des alertes..."
          if [ -f "metrics/aggregated_metrics.json" ]; then
            alerts_output=$(arkalia-metrics alerts \
              metrics/aggregated_metrics.json --threshold 10.0 2>&1) || true
            exit_code=$?
            if [ -z "$(echo "$alerts_output" | grep 'Aucune alerte')" ]; then
              echo "has-alerts=true" >> $GITHUB_OUTPUT
              echo "ðŸš¨ Alertes dÃ©tectÃ©es"
            else
              echo "has-alerts=false" >> $GITHUB_OUTPUT
              echo "âœ… Aucune alerte"
            fi
          else
            echo "has-alerts=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  MÃ©triques non disponibles pour vÃ©rification"
          fi

      - name: "CrÃ©er issue GitHub si alertes"
        if: steps.check-alerts.outputs.has-alerts == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“ CrÃ©ation d'une issue GitHub pour les alertes..."
          arkalia-metrics alerts metrics/aggregated_metrics.json \
            --threshold 10.0 \
            --create-issue \
            --github-owner arkalia-luna-system \
            --github-repo arkalia-metrics-collector \
            --verbose || echo "Issue peut-Ãªtre dÃ©jÃ  crÃ©Ã©e"

      - name: "VÃ©rifier les changements"
        id: check-changes
        run: |
          git diff --exit-code README.md metrics/ || \
            echo "has-changes=true" >> $GITHUB_OUTPUT
          if [ -z "$(git diff --exit-code README.md metrics/ || \
            echo 'changed')" ]; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Aucun changement dÃ©tectÃ©"
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changements dÃ©tectÃ©s"
            git diff --stat README.md metrics/
          fi

      - name: "Commit et Push"
        if: >
          steps.check-changes.outputs.has-changes == 'true' ||
          inputs.force_update == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md \
            metrics/aggregated_metrics.json \
            metrics/README_TABLE.md \
            metrics/badges_final.md

          git commit -m "ðŸ“Š Auto-update metrics [skip ci]" \
            -m "Mise Ã  jour automatique des mÃ©triques:" \
            -m "- MÃ©triques agrÃ©gÃ©es depuis 12 projets" \
            -m "- Tableau README mis Ã  jour" \
            -m "- Badges rÃ©gÃ©nÃ©rÃ©s" \
            || echo "Aucun changement Ã  commiter"

          # DÃ©terminer la branche cible
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          if [ "$CURRENT_BRANCH" = "develop" ] || [ "$CURRENT_BRANCH" = "main" ]; then
            git push origin "$CURRENT_BRANCH" || \
              echo "Push Ã©chouÃ© (peut-Ãªtre dÃ©jÃ  Ã  jour)"
          else
            # Par dÃ©faut, push sur develop si on n'est pas sur main ou develop
            git push origin develop || \
              echo "Push Ã©chouÃ© (peut-Ãªtre dÃ©jÃ  Ã  jour)"
          fi

      - name: "RÃ©sumÃ©"
        if: always()
        run: |
          echo "## ðŸ“Š RÃ©sumÃ© de la mise Ã  jour" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "metrics/aggregated_metrics.json" ]; then
            echo "âœ… MÃ©triques agrÃ©gÃ©es gÃ©nÃ©rÃ©es" >> $GITHUB_STEP_SUMMARY
            python3 << 'PYEOF'
          import json
          try:
              with open('metrics/aggregated_metrics.json') as f:
                  data = json.load(f)
              agg = data.get('aggregated', {})
              print(f"- **Modules Python**: {agg.get('total_modules', 0):,}")
              lines = agg.get('total_lines_of_code', 0)
              print(f"- **Lignes de code**: {lines:,}")
              print(f"- **Tests**: {agg.get('total_tests', 0):,}")
              print(f"- **Projets analysÃ©s**: {agg.get('total_projects', 0)}")
          except Exception as e:
              print(f"âŒ Erreur: {e}")
          PYEOF
          else
            echo "âŒ MÃ©triques non gÃ©nÃ©rÃ©es" >> $GITHUB_STEP_SUMMARY
          fi
