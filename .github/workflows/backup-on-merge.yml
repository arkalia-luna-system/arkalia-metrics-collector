# Workflow pour crÃ©er un backup lors du merge sur main
# DÃ©clenchÃ© automatiquement lors d'un push sur main

name: Backup on Merge to Main

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: "Version Ã  sauvegarder (optionnel, utilise la version du pyproject.toml si non fournie)"
        required: false
        type: string

env:
  PYTHON_VERSION: "3.11"
  PYTHONUNBUFFERED: 1

permissions:
  contents: write

jobs:
  create-backup:
    name: "CrÃ©er backup de version"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "DÃ©terminer la version"
        id: version
        env:
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          if [ -n "$INPUT_VERSION" ]; then
              VERSION="$INPUT_VERSION"
          else
              # Extraire la version depuis pyproject.toml
              VERSION=$(grep -E '^version\s*=' pyproject.toml | sed -E "s/^version\s*=\s*[\"']([^\"']+)[\"'].*/\1/" | head -1)
              if [ -z "$VERSION" ]; then
                  VERSION="unknown"
              fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version dÃ©tectÃ©e: $VERSION"

            - name: "CrÃ©er le dossier de backup"
              env:
                  VERSION: ${{ steps.version.outputs.version }}
              run: |
                  VERSION="${VERSION:-unknown}"
                  BACKUP_DIR="backups/v$VERSION"
                  mkdir -p "$BACKUP_DIR" || {
                      echo "âŒ Erreur lors de la crÃ©ation du dossier de backup"
                      exit 1
                  }
                  echo "backup-dir=$BACKUP_DIR" >> $GITHUB_OUTPUT
                  echo "ðŸ“ Dossier de backup crÃ©Ã©: $BACKUP_DIR"

      - name: "Sauvegarder les mÃ©triques"
        id: backup-metrics
        env:
          BACKUP_DIR_ENV: ${{ steps.version.outputs.backup-dir }}
          VERSION_ENV: ${{ steps.version.outputs.version }}
          GITHUB_SHA_ENV: ${{ github.sha }}
          GITHUB_REF_NAME_ENV: ${{ github.ref_name }}
          GITHUB_RUN_ID_ENV: ${{ github.run_id }}
        run: |
          # Utiliser BACKUP_DIR_ENV ou une valeur par dÃ©faut
          if [ -z "$BACKUP_DIR_ENV" ]; then
              BACKUP_DIR="backups/v${VERSION_ENV:-unknown}"
          else
              BACKUP_DIR="$BACKUP_DIR_ENV"
          fi
          TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")

          # CrÃ©er le dossier de backup
          mkdir -p "$BACKUP_DIR"

          # Sauvegarder les mÃ©triques si elles existent
          if [ -f "metrics/aggregated_metrics.json" ]; then
            cp "metrics/aggregated_metrics.json" "$BACKUP_DIR/aggregated_metrics_${TIMESTAMP}.json"
            echo "âœ… MÃ©triques agrÃ©gÃ©es sauvegardÃ©es"
          fi

          if [ -f "metrics/README_TABLE.md" ]; then
            cp "metrics/README_TABLE.md" "$BACKUP_DIR/README_TABLE_${TIMESTAMP}.md"
            echo "âœ… Tableau README sauvegardÃ©"
          fi

          if [ -f "metrics/badges_final.md" ]; then
            cp "metrics/badges_final.md" "$BACKUP_DIR/badges_${TIMESTAMP}.md"
            echo "âœ… Badges sauvegardÃ©s"
          fi

          # Sauvegarder l'historique des mÃ©triques si disponible
          if [ -d "metrics/history" ]; then
            cp -r "metrics/history" "$BACKUP_DIR/history_${TIMESTAMP}"
            echo "âœ… Historique sauvegardÃ©"
          fi

          # CrÃ©er un fichier de mÃ©tadonnÃ©es
          cat > "$BACKUP_DIR/backup_info.json" << EOF
          {
            "version": "$VERSION_ENV",
            "timestamp": "${TIMESTAMP}",
            "commit": "$GITHUB_SHA_ENV",
            "branch": "$GITHUB_REF_NAME_ENV",
            "workflow_run": "$GITHUB_RUN_ID_ENV",
            "backup_date": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF

          echo "backup-timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "âœ… MÃ©tadonnÃ©es de backup crÃ©Ã©es"

      - name: "CrÃ©er un fichier README pour le backup"
        env:
          BACKUP_DIR_ENV: ${{ steps.version.outputs.backup-dir }}
          VERSION_ENV: ${{ steps.version.outputs.version }}
        run: |
          # Utiliser BACKUP_DIR_ENV ou une valeur par dÃ©faut
          if [ -z "$BACKUP_DIR_ENV" ]; then
              BACKUP_DIR="backups/v${VERSION_ENV:-unknown}"
          else
              BACKUP_DIR="$BACKUP_DIR_ENV"
          fi
          cat > "$BACKUP_DIR/README.md" << 'EOF'
          # Backup de Version

          Ce dossier contient un backup des mÃ©triques et fichiers associÃ©s pour cette version.

          ## Contenu

          - `aggregated_metrics_*.json` : MÃ©triques agrÃ©gÃ©es au moment du backup
          - `README_TABLE_*.md` : Tableau README gÃ©nÃ©rÃ©
          - `badges_*.md` : Badges gÃ©nÃ©rÃ©s
          - `history_*` : Historique des mÃ©triques (si disponible)
          - `backup_info.json` : MÃ©tadonnÃ©es du backup

          ## Utilisation

          Ce backup a Ã©tÃ© crÃ©Ã© automatiquement lors du merge sur la branche `main`.
          Il permet de conserver un historique des mÃ©triques pour chaque version.
          EOF
          echo "âœ… README de backup crÃ©Ã©"

      - name: "Commit et Push du backup"
        env:
          VERSION_ENV: ${{ steps.version.outputs.version }}
          GITHUB_SHA_ENV: ${{ github.sha }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "backups/"

          git commit -m "ðŸ’¾ Backup version $VERSION_ENV" \
            -m "Backup automatique crÃ©Ã© lors du merge sur main" \
            -m "Version: $VERSION_ENV" \
            -m "Commit: $GITHUB_SHA_ENV" \
            || echo "Aucun changement Ã  commiter"

          git push origin main || \
            echo "Push Ã©chouÃ© (peut-Ãªtre dÃ©jÃ  Ã  jour)"

      - name: "RÃ©sumÃ©"
        if: always()
        env:
          VERSION_ENV: ${{ steps.version.outputs.version }}
          BACKUP_DIR_ENV: ${{ steps.version.outputs.backup-dir }}
          BACKUP_TIMESTAMP_ENV: ${{ steps.backup-metrics.outputs.backup-timestamp }}
          GITHUB_SHA_ENV: ${{ github.sha }}
        run: |
          echo "## ðŸ’¾ RÃ©sumÃ© du Backup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION_ENV" >> $GITHUB_STEP_SUMMARY
          echo "- **Dossier**: $BACKUP_DIR_ENV" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $BACKUP_TIMESTAMP_ENV" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: $GITHUB_SHA_ENV" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Backup crÃ©Ã© avec succÃ¨s" >> $GITHUB_STEP_SUMMARY
